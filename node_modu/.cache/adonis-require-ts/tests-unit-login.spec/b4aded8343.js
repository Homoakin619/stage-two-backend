"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const runner_1 = require("@japa/runner");
const sinon_1 = __importDefault(require("sinon"));
const UserAuthenticationController_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Controllers/Http/UserAuthenticationController"));
const UserAction_1 = global[Symbol.for('ioc.use')]("App/Actions/UserAction");
const Hash_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Hash"));
const StatusCodes_1 = global[Symbol.for('ioc.use')]("App/Helpers/StatusCodes");
const appConfig_1 = __importDefault(global[Symbol.for('ioc.use')]("Config/appConfig"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
runner_1.test.group('UserAuthenticationController', (group) => {
    let sandbox;
    group.setup(() => {
        sandbox = sinon_1.default.createSandbox();
    });
    group.teardown(() => {
        sandbox.restore();
    });
    (0, runner_1.test)('should authenticate user and return access token', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        const user = new User_1.default();
        user.fill({
            userId: 'user-id',
            email: 'john.doe@example.com',
            password: 'password123',
            firstName: "john",
            lastName: "doe",
            phone: "09123456789"
        });
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').resolves(user);
        sandbox.stub(Hash_1.default, 'verify').resolves(true);
        sandbox.stub(appConfig_1.default, 'tokenExpiryTimeFrame').value(60);
        const authStub = {
            use: sandbox.stub().returnsThis(),
            attempt: sandbox.stub().resolves({ token: 'access-token' })
        };
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: authStub };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.OK));
        assert.isTrue(response.send.calledWith({
            status: 'success',
            message: 'Login successful',
            data: {
                accessToken: 'access-token',
                user: { id: 'user-id', email: 'john.doe@example.com' }
            }
        }));
    });
    (0, runner_1.test)('should return 422 if validation fails', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        const request = {
            validate: sandbox.stub().throws({ messages: { errors: ['Validation failed'] } })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.UNPROCESSABLE_ENTITY));
        assert.isTrue(response.send.calledWith({
            errors: ['Validation failed']
        }));
    });
    (0, runner_1.test)('should return 401 if authentication fails', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').resolves(null);
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.UNAUTHORIZED));
        assert.isTrue(response.send.calledWith({
            status: 'Bad Request',
            message: 'Authentication failed',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.UNAUTHORIZED
        }));
    });
    (0, runner_1.test)('should return 500 if an error occurs', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').throws(new Error('Simulated error'));
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR));
        assert.isTrue(response.send.calledWith({
            status: 'Error',
            message: 'Error Occured',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR
        }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvZ2luLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx5Q0FBbUM7QUFDbkMsa0RBQXlCO0FBRXpCLDJJQUE0RjtBQUM1Riw2RUFBb0Q7QUFDcEQsa0ZBQXdDO0FBQ3hDLCtFQUE0RDtBQUM1RCx1RkFBd0M7QUFFeEMsaUZBQWtDO0FBRWxDLGFBQUksQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNqRCxJQUFJLE9BQTJCLENBQUE7SUFFL0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7UUFDYixPQUFPLEdBQUcsZUFBSyxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ25DLENBQUMsQ0FBQyxDQUFBO0lBRUYsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDaEIsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3JCLENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBQSxhQUFJLEVBQUMsa0RBQWtELEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUMxRSxNQUFNLFVBQVUsR0FBRyxJQUFJLHNDQUE0QixFQUFFLENBQUE7UUFDckQsTUFBTSxJQUFJLEdBQUcsSUFBSSxjQUFJLEVBQUUsQ0FBQTtRQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ04sTUFBTSxFQUFFLFNBQVM7WUFDakIsS0FBSyxFQUFFLHNCQUFzQjtZQUM3QixRQUFRLEVBQUUsYUFBYTtZQUN2QixTQUFTLEVBQUUsTUFBTTtZQUNqQixRQUFRLEVBQUUsS0FBSztZQUNmLEtBQUssRUFBRSxhQUFhO1NBQ3ZCLENBQUMsQ0FBQTtRQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsd0JBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFekQsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFJ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R0FBRyxJQUFJLHNDQUE0QixFQUFFLENBQUE7UUFFckQsT0FBTyxDQUFDLElBQUksQ0FBQyx3QkFBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUE7UUFFL0UsTUFBTSxPQUFPLEdBQUc7WUFDWixRQUFRLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUNuQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxzQkFBc0IsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLENBQUM7U0FDM0YsQ0FBQTtRQUVELE1BQU0sUUFBUSxHQUFHO1lBQ2IsTUFBTSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDcEMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7U0FDdkIsQ0FBQTtRQUVELE1BQU0sR0FBRyxHQUFHLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFvQyxDQUFBO1FBRTdFLE1BQU0sVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUU1QixNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGdDQUFrQixDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQTtRQUNuRixNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ25DLE1BQU0sRUFBRSxPQUFPO1lBQ2YsT0FBTyxFQUFFLGVBQWU7WUFDeEIsVUFBVSxFQUFFLGdDQUFrQixDQUFDLHFCQUFxQjtTQUN2RCxDQUFDLENBQUMsQ0FBQTtJQUNQLENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0ZXN0IH0gZnJvbSAnQGphcGEvcnVubmVyJ1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJ1xuaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgVXNlckF1dGhlbnRpY2F0aW9uQ29udHJvbGxlciBmcm9tICdBcHAvQ29udHJvbGxlcnMvSHR0cC9Vc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyJ1xuaW1wb3J0IHsgVXNlckFjdGlvbnMgfSBmcm9tICdBcHAvQWN0aW9ucy9Vc2VyQWN0aW9uJ1xuaW1wb3J0IEhhc2ggZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IYXNoJ1xuaW1wb3J0IHsgSHR0cFN0YXR1c0NvZGVFbnVtIH0gZnJvbSAnQXBwL0hlbHBlcnMvU3RhdHVzQ29kZXMnXG5pbXBvcnQgYXBwQ29uZmlnIGZyb20gJ0NvbmZpZy9hcHBDb25maWcnXG5pbXBvcnQgeyBEYXRlVGltZSB9IGZyb20gJ2x1eG9uJ1xuaW1wb3J0IFVzZXIgZnJvbSAnQXBwL01vZGVscy9Vc2VyJ1xuXG50ZXN0Lmdyb3VwKCdVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyJywgKGdyb3VwKSA9PiB7XG4gICAgbGV0IHNhbmRib3g6IHNpbm9uLlNpbm9uU2FuZGJveFxuXG4gICAgZ3JvdXAuc2V0dXAoKCkgPT4ge1xuICAgICAgICBzYW5kYm94ID0gc2lub24uY3JlYXRlU2FuZGJveCgpXG4gICAgfSlcblxuICAgIGdyb3VwLnRlYXJkb3duKCgpID0+IHtcbiAgICAgICAgc2FuZGJveC5yZXN0b3JlKClcbiAgICB9KVxuXG4gICAgdGVzdCgnc2hvdWxkIGF1dGhlbnRpY2F0ZSB1c2VyIGFuZCByZXR1cm4gYWNjZXNzIHRva2VuJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyKClcbiAgICAgICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKClcbiAgICAgICAgdXNlci5maWxsKHtcbiAgICAgICAgICAgIHVzZXJJZDogJ3VzZXItaWQnLFxuICAgICAgICAgICAgZW1haWw6ICdqb2huLmRvZUBleGFtcGxlLmNvbScsXG4gICAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJyxcbiAgICAgICAgICAgIGZpcnN0TmFtZTogXCJqb2huXCIsXG4gICAgICAgICAgICBsYXN0TmFtZTogXCJkb2VcIixcbiAgICAgICAgICAgIHBob25lOiBcIjA5MTIzNDU2Nzg5XCJcbiAgICAgICAgfSlcbiAgICAgICAgLy8gTW9jayBkZXBlbmRlbmNpZXNcbiAgICAgICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZ2V0VXNlclJlY29yZCcpLnJlc29sdmVzKHVzZXIpXG5cbiAgICAgICAgc2FuZGJveC5zdHViKEhhc2gsICd2ZXJpZnknKS5yZXNvbHZlcyh0cnVlKVxuICAgICAgICBzYW5kYm94LnN0dWIoYXBwQ29uZmlnLCAndG9rZW5FeHBpcnlUaW1lRnJhbWUnKS52YWx1ZSg2MClcbiAgICAgICAgY29uc3QgYXV0aFN0dWIgPSB7XG4gICAgICAgICAgICB1c2U6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICAgICAgICBhdHRlbXB0OiBzYW5kYm94LnN0dWIoKS5yZXNvbHZlcyh7IHRva2VuOiAnYWNjZXNzLXRva2VuJyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICAgIHZhbGlkYXRlOiBzYW5kYm94LnN0dWIoKS5yZXNvbHZlcygpLFxuICAgICAgICAgICAgYm9keTogc2FuZGJveC5zdHViKCkucmV0dXJucyh7IGVtYWlsOiAnam9obi5kb2VAZXhhbXBsZS5jb20nLCBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgICBzdGF0dXM6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICAgICAgICBzZW5kOiBzYW5kYm94LnN0dWIoKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3R4ID0geyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aDogYXV0aFN0dWIgfSBhcyB1bmtub3duIGFzIEh0dHBDb250ZXh0Q29udHJhY3RcblxuICAgICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgICAgICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zdGF0dXMuY2FsbGVkV2l0aChIdHRwU3RhdHVzQ29kZUVudW0uT0spKVxuICAgICAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnNlbmQuY2FsbGVkV2l0aCh7XG4gICAgICAgICAgICBzdGF0dXM6ICdzdWNjZXNzJyxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdMb2dpbiBzdWNjZXNzZnVsJyxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBhY2Nlc3NUb2tlbjogJ2FjY2Vzcy10b2tlbicsXG4gICAgICAgICAgICAgICAgdXNlcjogeyBpZDogJ3VzZXItaWQnLCBlbWFpbDogJ2pvaG4uZG9lQGV4YW1wbGUuY29tJyB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQyMiBpZiB2YWxpZGF0aW9uIGZhaWxzJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyKClcblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdmFsaWRhdGU6IHNhbmRib3guc3R1YigpLnRocm93cyh7IG1lc3NhZ2VzOiB7IGVycm9yczogWydWYWxpZGF0aW9uIGZhaWxlZCddIH0gfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgc3RhdHVzOiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zVGhpcygpLFxuICAgICAgICAgICAgc2VuZDogc2FuZGJveC5zdHViKClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN0eCA9IHsgcmVxdWVzdCwgcmVzcG9uc2UsIGF1dGg6IHt9IH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGUoY3R4KVxuXG4gICAgICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc3RhdHVzLmNhbGxlZFdpdGgoSHR0cFN0YXR1c0NvZGVFbnVtLlVOUFJPQ0VTU0FCTEVfRU5USVRZKSlcbiAgICAgICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAgICAgICAgICAgZXJyb3JzOiBbJ1ZhbGlkYXRpb24gZmFpbGVkJ11cbiAgICAgICAgfSkpXG4gICAgfSlcblxuICAgIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDAxIGlmIGF1dGhlbnRpY2F0aW9uIGZhaWxzJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyKClcblxuICAgICAgICBzYW5kYm94LnN0dWIoVXNlckFjdGlvbnMsICdnZXRVc2VyUmVjb3JkJykucmVzb2x2ZXMobnVsbClcblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdmFsaWRhdGU6IHNhbmRib3guc3R1YigpLnJlc29sdmVzKCksXG4gICAgICAgICAgICBib2R5OiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zKHsgZW1haWw6ICdqb2huLmRvZUBleGFtcGxlLmNvbScsIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogc2FuZGJveC5zdHViKCkucmV0dXJuc1RoaXMoKSxcbiAgICAgICAgICAgIHNlbmQ6IHNhbmRib3guc3R1YigpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjdHggPSB7IHJlcXVlc3QsIHJlc3BvbnNlLCBhdXRoOiB7fSB9IGFzIHVua25vd24gYXMgSHR0cENvbnRleHRDb250cmFjdFxuXG4gICAgICAgIGF3YWl0IGNvbnRyb2xsZXIuaGFuZGxlKGN0eClcblxuICAgICAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnN0YXR1cy5jYWxsZWRXaXRoKEh0dHBTdGF0dXNDb2RlRW51bS5VTkFVVEhPUklaRUQpKVxuICAgICAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnNlbmQuY2FsbGVkV2l0aCh7XG4gICAgICAgICAgICBzdGF0dXM6ICdCYWQgUmVxdWVzdCcsXG4gICAgICAgICAgICBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IEh0dHBTdGF0dXNDb2RlRW51bS5VTkFVVEhPUklaRURcbiAgICAgICAgfSkpXG4gICAgfSlcblxuICAgIHRlc3QoJ3Nob3VsZCByZXR1cm4gNTAwIGlmIGFuIGVycm9yIG9jY3VycycsIGFzeW5jICh7IGFzc2VydCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgVXNlckF1dGhlbnRpY2F0aW9uQ29udHJvbGxlcigpXG5cbiAgICAgICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZ2V0VXNlclJlY29yZCcpLnRocm93cyhuZXcgRXJyb3IoJ1NpbXVsYXRlZCBlcnJvcicpKVxuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICB2YWxpZGF0ZTogc2FuZGJveC5zdHViKCkucmVzb2x2ZXMoKSxcbiAgICAgICAgICAgIGJvZHk6IHNhbmRib3guc3R1YigpLnJldHVybnMoeyBlbWFpbDogJ2pvaG4uZG9lQGV4YW1wbGUuY29tJywgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMycgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgc3RhdHVzOiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zVGhpcygpLFxuICAgICAgICAgICAgc2VuZDogc2FuZGJveC5zdHViKClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN0eCA9IHsgcmVxdWVzdCwgcmVzcG9uc2UsIGF1dGg6IHt9IH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGUoY3R4KVxuXG4gICAgICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc3RhdHVzLmNhbGxlZFdpdGgoSHR0cFN0YXR1c0NvZGVFbnVtLklOVEVSTkFMX1NFUlZFUl9FUlJPUikpXG4gICAgICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc2VuZC5jYWxsZWRXaXRoKHtcbiAgICAgICAgICAgIHN0YXR1czogJ0Vycm9yJyxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdFcnJvciBPY2N1cmVkJyxcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IEh0dHBTdGF0dXNDb2RlRW51bS5JTlRFUk5BTF9TRVJWRVJfRVJST1JcbiAgICAgICAgfSkpXG4gICAgfSlcbn0pXG4iXX0=