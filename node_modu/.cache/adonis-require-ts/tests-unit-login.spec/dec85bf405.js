"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const runner_1 = require("@japa/runner");
const sinon_1 = __importDefault(require("sinon"));
const UserAuthenticationController_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Controllers/Http/UserAuthenticationController"));
const UserAction_1 = global[Symbol.for('ioc.use')]("App/Actions/UserAction");
const Hash_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Hash"));
const StatusCodes_1 = global[Symbol.for('ioc.use')]("App/Helpers/StatusCodes");
const appConfig_1 = __importDefault(global[Symbol.for('ioc.use')]("Config/appConfig"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
runner_1.test.group('UserAuthenticationController', (group) => {
    let sandbox;
    group.setup(() => {
        sandbox = sinon_1.default.createSandbox();
    });
    group.teardown(() => {
        sandbox.restore();
    });
    (0, runner_1.test)('should authenticate user and return access token', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        const user = new User_1.default();
        user.fill({
            userId: 'user-id',
            email: 'john.doe@example.com',
            password: 'password123',
            firstName: "john",
            lastName: "doe",
            phone: "09123456789"
        });
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').resolves(user);
        sandbox.stub(Hash_1.default, 'verify').resolves(true);
        sandbox.stub(appConfig_1.default, 'tokenExpiryTimeFrame').value(60);
        const authStub = {
            use: sandbox.stub().returnsThis(),
            attempt: sandbox.stub().resolves({ token: 'access-token' })
        };
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: authStub };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.OK));
    });
    (0, runner_1.test)('should return 422 if validation fails', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        const request = {
            validate: sandbox.stub().throws({ messages: { errors: ['Validation failed'] } })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.UNPROCESSABLE_ENTITY));
        assert.isTrue(response.send.calledWith({
            errors: ['Validation failed']
        }));
    });
    (0, runner_1.test)('should return 401 if authentication fails', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').resolves(null);
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.UNAUTHORIZED));
        assert.isTrue(response.send.calledWith({
            status: 'Bad Request',
            message: 'Authentication failed',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.UNAUTHORIZED
        }));
    });
    (0, runner_1.test)('should return 500 if an error occurs', async ({ assert }) => {
        const controller = new UserAuthenticationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').throws(new Error('Simulated error'));
        const request = {
            validate: sandbox.stub().resolves(),
            body: sandbox.stub().returns({ email: 'john.doe@example.com', password: 'password123' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR));
        assert.isTrue(response.send.calledWith({
            status: 'Error',
            message: 'Error Occured',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR
        }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvZ2luLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx5Q0FBbUM7QUFDbkMsa0RBQXlCO0FBRXpCLDJJQUE0RjtBQUM1Riw2RUFBb0Q7QUFDcEQsa0ZBQXdDO0FBQ3hDLCtFQUE0RDtBQUM1RCx1RkFBd0M7QUFFeEMsaUZBQWtDO0FBRWxDLGFBQUksQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNqRCxJQUFJLE9BQTJCLENBQUE7SUFFL0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7UUFDYixPQUFPLEdBQUcsZUFBSyxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ25DLENBQUMsQ0FBQyxDQUFBO0lBRUYsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDaEIsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3JCLENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBQSxhQUFJLEVBQUMsa0RBQWtELEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUMxRSxNQUFNLFVBQVUsR0FBRyxJQUFJLHNDQUE0QixFQUFFLENBQUE7UUFDckQsTUFBTSxJQUFJLEdBQUcsSUFBSSxjQUFJLEVBQUUsQ0FBQTtRQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ04sTUFBTSxFQUFFLFNBQVM7WUFDakIsS0FBSyxFQUFFLHNCQUFzQjtZQUM3QixRQUFRLEVBQUUsYUFBYTtZQUN2QixTQUFTLEVBQUUsTUFBTTtZQUNqQixRQUFRLEVBQUUsS0FBSztZQUNmLEtBQUssRUFBRSxhQUFhO1NBQ3ZCLENBQUMsQ0FBQTtRQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsd0JBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFekQsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFJ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SSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLHNCQUFzQixFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsQ0FBQztTQUMzRixDQUFBO1FBRUQsTUFBTSxRQUFRLEdBQUc7WUFDYixNQUFNLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtZQUNwQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRTtTQUN2QixDQUFBO1FBRUQsTUFBTSxHQUFHLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQW9DLENBQUE7UUFFN0UsTUFBTSxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRTVCLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsZ0NBQWtCLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFBO1FBQ25GLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDbkMsTUFBTSxFQUFFLE9BQU87WUFDZixPQUFPLEVBQUUsZUFBZTtZQUN4QixVQUFVLEVBQUUsZ0NBQWtCLENBQUMscUJBQXFCO1NBQ3ZELENBQUMsQ0FBQyxDQUFBO0lBQ1AsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRlc3QgfSBmcm9tICdAamFwYS9ydW5uZXInXG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nXG5pbXBvcnQgeyBIdHRwQ29udGV4dENvbnRyYWN0IH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcbmltcG9ydCBVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyIGZyb20gJ0FwcC9Db250cm9sbGVycy9IdHRwL1VzZXJBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXInXG5pbXBvcnQgeyBVc2VyQWN0aW9ucyB9IGZyb20gJ0FwcC9BY3Rpb25zL1VzZXJBY3Rpb24nXG5pbXBvcnQgSGFzaCBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0hhc2gnXG5pbXBvcnQgeyBIdHRwU3RhdHVzQ29kZUVudW0gfSBmcm9tICdBcHAvSGVscGVycy9TdGF0dXNDb2RlcydcbmltcG9ydCBhcHBDb25maWcgZnJvbSAnQ29uZmlnL2FwcENvbmZpZydcbmltcG9ydCB7IERhdGVUaW1lIH0gZnJvbSAnbHV4b24nXG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInXG5cbnRlc3QuZ3JvdXAoJ1VzZXJBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXInLCAoZ3JvdXApID0+IHtcbiAgICBsZXQgc2FuZGJveDogc2lub24uU2lub25TYW5kYm94XG5cbiAgICBncm91cC5zZXR1cCgoKSA9PiB7XG4gICAgICAgIHNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KClcbiAgICB9KVxuXG4gICAgZ3JvdXAudGVhcmRvd24oKCkgPT4ge1xuICAgICAgICBzYW5kYm94LnJlc3RvcmUoKVxuICAgIH0pXG5cbiAgICB0ZXN0KCdzaG91bGQgYXV0aGVudGljYXRlIHVzZXIgYW5kIHJldHVybiBhY2Nlc3MgdG9rZW4nLCBhc3luYyAoeyBhc3NlcnQgfSkgPT4ge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IFVzZXJBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXIoKVxuICAgICAgICBjb25zdCB1c2VyID0gbmV3IFVzZXIoKVxuICAgICAgICB1c2VyLmZpbGwoe1xuICAgICAgICAgICAgdXNlcklkOiAndXNlci1pZCcsXG4gICAgICAgICAgICBlbWFpbDogJ2pvaG4uZG9lQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnLFxuICAgICAgICAgICAgZmlyc3ROYW1lOiBcImpvaG5cIixcbiAgICAgICAgICAgIGxhc3ROYW1lOiBcImRvZVwiLFxuICAgICAgICAgICAgcGhvbmU6IFwiMDkxMjM0NTY3ODlcIlxuICAgICAgICB9KVxuICAgICAgICAvLyBNb2NrIGRlcGVuZGVuY2llc1xuICAgICAgICBzYW5kYm94LnN0dWIoVXNlckFjdGlvbnMsICdnZXRVc2VyUmVjb3JkJykucmVzb2x2ZXModXNlcilcblxuICAgICAgICBzYW5kYm94LnN0dWIoSGFzaCwgJ3ZlcmlmeScpLnJlc29sdmVzKHRydWUpXG4gICAgICAgIHNhbmRib3guc3R1YihhcHBDb25maWcsICd0b2tlbkV4cGlyeVRpbWVGcmFtZScpLnZhbHVlKDYwKVxuICAgICAgICBjb25zdCBhdXRoU3R1YiA9IHtcbiAgICAgICAgICAgIHVzZTogc2FuZGJveC5zdHViKCkucmV0dXJuc1RoaXMoKSxcbiAgICAgICAgICAgIGF0dGVtcHQ6IHNhbmRib3guc3R1YigpLnJlc29sdmVzKHsgdG9rZW46ICdhY2Nlc3MtdG9rZW4nIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdmFsaWRhdGU6IHNhbmRib3guc3R1YigpLnJlc29sdmVzKCksXG4gICAgICAgICAgICBib2R5OiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zKHsgZW1haWw6ICdqb2huLmRvZUBleGFtcGxlLmNvbScsIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogc2FuZGJveC5zdHViKCkucmV0dXJuc1RoaXMoKSxcbiAgICAgICAgICAgIHNlbmQ6IHNhbmRib3guc3R1YigpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjdHggPSB7IHJlcXVlc3QsIHJlc3BvbnNlLCBhdXRoOiBhdXRoU3R1YiB9IGFzIHVua25vd24gYXMgSHR0cENvbnRleHRDb250cmFjdFxuXG4gICAgICAgIGF3YWl0IGNvbnRyb2xsZXIuaGFuZGxlKGN0eClcblxuICAgICAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnN0YXR1cy5jYWxsZWRXaXRoKEh0dHBTdGF0dXNDb2RlRW51bS5PSykpXG4gICAgICAgIC8vIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc2VuZC5jYWxsZWRXaXRoKHtcbiAgICAgICAgLy8gICAgIHN0YXR1czogJ3N1Y2Nlc3MnLFxuICAgICAgICAvLyAgICAgbWVzc2FnZTogJ0xvZ2luIHN1Y2Nlc3NmdWwnLFxuICAgICAgICAvLyAgICAgZGF0YToge1xuICAgICAgICAvLyAgICAgICAgIGFjY2Vzc1Rva2VuOiAnYWNjZXNzLXRva2VuJyxcbiAgICAgICAgLy8gICAgICAgICB1c2VyOiB7IGlkOiAndXNlci1pZCcsIGVtYWlsOiAnam9obi5kb2VAZXhhbXBsZS5jb20nIH1cbiAgICAgICAgLy8gICAgIH1cbiAgICAgICAgLy8gfSkpXG4gICAgfSlcblxuICAgIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDIyIGlmIHZhbGlkYXRpb24gZmFpbHMnLCBhc3luYyAoeyBhc3NlcnQgfSkgPT4ge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IFVzZXJBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXIoKVxuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICB2YWxpZGF0ZTogc2FuZGJveC5zdHViKCkudGhyb3dzKHsgbWVzc2FnZXM6IHsgZXJyb3JzOiBbJ1ZhbGlkYXRpb24gZmFpbGVkJ10gfSB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgICBzdGF0dXM6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICAgICAgICBzZW5kOiBzYW5kYm94LnN0dWIoKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3R4ID0geyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aDoge30gfSBhcyB1bmtub3duIGFzIEh0dHBDb250ZXh0Q29udHJhY3RcblxuICAgICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgICAgICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zdGF0dXMuY2FsbGVkV2l0aChIdHRwU3RhdHVzQ29kZUVudW0uVU5QUk9DRVNTQUJMRV9FTlRJVFkpKVxuICAgICAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnNlbmQuY2FsbGVkV2l0aCh7XG4gICAgICAgICAgICBlcnJvcnM6IFsnVmFsaWRhdGlvbiBmYWlsZWQnXVxuICAgICAgICB9KSlcbiAgICB9KVxuXG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiA0MDEgaWYgYXV0aGVudGljYXRpb24gZmFpbHMnLCBhc3luYyAoeyBhc3NlcnQgfSkgPT4ge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IFVzZXJBdXRoZW50aWNhdGlvbkNvbnRyb2xsZXIoKVxuXG4gICAgICAgIHNhbmRib3guc3R1YihVc2VyQWN0aW9ucywgJ2dldFVzZXJSZWNvcmQnKS5yZXNvbHZlcyhudWxsKVxuXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgICB2YWxpZGF0ZTogc2FuZGJveC5zdHViKCkucmVzb2x2ZXMoKSxcbiAgICAgICAgICAgIGJvZHk6IHNhbmRib3guc3R1YigpLnJldHVybnMoeyBlbWFpbDogJ2pvaG4uZG9lQGV4YW1wbGUuY29tJywgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMycgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgc3RhdHVzOiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zVGhpcygpLFxuICAgICAgICAgICAgc2VuZDogc2FuZGJveC5zdHViKClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGN0eCA9IHsgcmVxdWVzdCwgcmVzcG9uc2UsIGF1dGg6IHt9IH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgICAgICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGUoY3R4KVxuXG4gICAgICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc3RhdHVzLmNhbGxlZFdpdGgoSHR0cFN0YXR1c0NvZGVFbnVtLlVOQVVUSE9SSVpFRCkpXG4gICAgICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc2VuZC5jYWxsZWRXaXRoKHtcbiAgICAgICAgICAgIHN0YXR1czogJ0JhZCBSZXF1ZXN0JyxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBmYWlsZWQnLFxuICAgICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1c0NvZGVFbnVtLlVOQVVUSE9SSVpFRFxuICAgICAgICB9KSlcbiAgICB9KVxuXG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiA1MDAgaWYgYW4gZXJyb3Igb2NjdXJzJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBVc2VyQXV0aGVudGljYXRpb25Db250cm9sbGVyKClcblxuICAgICAgICBzYW5kYm94LnN0dWIoVXNlckFjdGlvbnMsICdnZXRVc2VyUmVjb3JkJykudGhyb3dzKG5ldyBFcnJvcignU2ltdWxhdGVkIGVycm9yJykpXG5cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICAgIHZhbGlkYXRlOiBzYW5kYm94LnN0dWIoKS5yZXNvbHZlcygpLFxuICAgICAgICAgICAgYm9keTogc2FuZGJveC5zdHViKCkucmV0dXJucyh7IGVtYWlsOiAnam9obi5kb2VAZXhhbXBsZS5jb20nLCBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgICBzdGF0dXM6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICAgICAgICBzZW5kOiBzYW5kYm94LnN0dWIoKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3R4ID0geyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aDoge30gfSBhcyB1bmtub3duIGFzIEh0dHBDb250ZXh0Q29udHJhY3RcblxuICAgICAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgICAgICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zdGF0dXMuY2FsbGVkV2l0aChIdHRwU3RhdHVzQ29kZUVudW0uSU5URVJOQUxfU0VSVkVSX0VSUk9SKSlcbiAgICAgICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAgICAgICAgICAgc3RhdHVzOiAnRXJyb3InLFxuICAgICAgICAgICAgbWVzc2FnZTogJ0Vycm9yIE9jY3VyZWQnLFxuICAgICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1c0NvZGVFbnVtLklOVEVSTkFMX1NFUlZFUl9FUlJPUlxuICAgICAgICB9KSlcbiAgICB9KVxufSlcbiJdfQ==