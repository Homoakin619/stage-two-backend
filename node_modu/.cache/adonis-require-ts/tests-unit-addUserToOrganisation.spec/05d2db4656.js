"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const runner_1 = require("@japa/runner");
const sinon_1 = __importDefault(require("sinon"));
const AddUserToOrganisationController_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Controllers/Http/AddUserToOrganisationController"));
const OrganisationAction_1 = global[Symbol.for('ioc.use')]("App/Actions/OrganisationAction");
const UserAction_1 = global[Symbol.for('ioc.use')]("App/Actions/UserAction");
const StatusCodes_1 = global[Symbol.for('ioc.use')]("App/Helpers/StatusCodes");
const Organisation_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Organisation"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
runner_1.test.group('AddUserToOrganisationController', (group) => {
    let sandbox;
    group.setup(() => {
        sandbox = sinon_1.default.createSandbox();
    });
    group.teardown(() => {
        sandbox.restore();
    });
    (0, runner_1.test)('should add user to organisation successfully', async ({ assert }) => {
        const controller = new AddUserToOrganisationController_1.default();
        const organisation = new Organisation_1.default();
        organisation.fill({ orgId: 'organisation-id', description: "nice organisation", name: "new organisation" });
        const newUser = new User_1.default();
        newUser.fill({
            userId: 'users-id',
            email: 'johns.doe@examples.com',
            password: 'password123',
            firstName: "johns",
            lastName: "doe",
            phone: "09123456789"
        });
        const user = new User_1.default();
        user.fill({
            userId: 'user-id',
            email: 'john.doe@example.com',
            password: 'password123',
            firstName: "john",
            lastName: "doe",
            phone: "09123456789"
        });
        await OrganisationAction_1.OrganisationActions.addUserToOrganisation({ userId: user.id, orgId: organisation.id });
        sandbox.stub(UserAction_1.UserActions, 'fetchUserOrganisations').resolves([
            organisation
        ]);
        sandbox.stub(OrganisationAction_1.OrganisationActions, 'getOrganisationRecord').resolves(organisation);
        sandbox.stub(UserAction_1.UserActions, 'getUserRecord').resolves(user);
        sandbox.stub(OrganisationAction_1.OrganisationActions, 'addUserToOrganisation').resolves();
        const request = {
            validate: sandbox.stub().resolves(),
            param: sandbox.stub().returns('organisation-id'),
            body: sandbox.stub().returns({ userId: 'user-id' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const auth = { user: user };
        const ctx = { request, response, auth };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.OK));
        assert.isTrue(response.send.calledWith({
            status: 'success',
            message: 'User added to organisation successfully',
        }));
    });
    (0, runner_1.test)('should return 422 if validation fails', async ({ assert }) => {
        const controller = new AddUserToOrganisationController_1.default();
        const request = {
            validate: sandbox.stub().throws({ messages: { errors: ['Validation failed'] } })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const ctx = { request, response, auth: {} };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.UNPROCESSABLE_ENTITY));
        assert.isTrue(response.send.calledWith({
            errors: ['Validation failed']
        }));
    });
    (0, runner_1.test)('should return 400 if organisation is not found for user', async ({ assert }) => {
        const controller = new AddUserToOrganisationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'fetchUserOrganisations').resolves([]);
        const request = {
            validate: sandbox.stub().resolves(),
            param: sandbox.stub().returns('organisation-id'),
            body: sandbox.stub().returns({ userId: 'user-id' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const auth = { user: { userId: 'logged-in-user-id' } };
        const ctx = { request, response, auth };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.BAD_REQUEST));
        assert.isTrue(response.send.calledWith({
            status: 'Bad Request',
            message: 'Organisation not found for user',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.BAD_REQUEST
        }));
    });
    (0, runner_1.test)('should return 500 if an error occurs', async ({ assert }) => {
        const controller = new AddUserToOrganisationController_1.default();
        sandbox.stub(UserAction_1.UserActions, 'fetchUserOrganisations').throws(new Error('Simulated error'));
        const request = {
            validate: sandbox.stub().resolves(),
            param: sandbox.stub().returns('organisation-id'),
            body: sandbox.stub().returns({ userId: 'user-id' })
        };
        const response = {
            status: sandbox.stub().returnsThis(),
            send: sandbox.stub()
        };
        const auth = { user: { userId: 'logged-in-user-id' } };
        const ctx = { request, response, auth };
        await controller.handle(ctx);
        assert.isTrue(response.status.calledWith(StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR));
        assert.isTrue(response.send.calledWith({
            status: 'Error',
            message: 'Error Occured Adding User',
            statusCode: StatusCodes_1.HttpStatusCodeEnum.INTERNAL_SERVER_ERROR
        }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkVXNlclRvT3JnYW5pc2F0aW9uLnNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhZGRVc2VyVG9PcmdhbmlzYXRpb24uc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlDQUFtQztBQUNuQyxrREFBeUI7QUFFekIsaUpBQWtHO0FBQ2xHLDZGQUFvRTtBQUNwRSw2RUFBb0Q7QUFDcEQsK0VBQTREO0FBQzVELGlHQUFrRDtBQUNsRCxpRkFBa0M7QUFFbEMsYUFBSSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ3RELElBQUksT0FBMkIsQ0FBQTtJQUUvQixLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRTtRQUNmLE9BQU8sR0FBRyxlQUFLLENBQUMsYUFBYSxFQUFFLENBQUE7SUFDakMsQ0FBQyxDQUFDLENBQUE7SUFFRixLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRTtRQUNsQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDbkIsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFBLGFBQUksRUFBQyw4Q0FBOEMsRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFO1FBQ3hFLE1BQU0sVUFBVSxHQUFHLElBQUkseUNBQStCLEVBQUUsQ0FBQTtRQUN4RCxNQUFNLFlBQVksR0FBRyxJQUFJLHNCQUFZLEVBQUUsQ0FBQTtRQUN2QyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFDLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFBO1FBRzFHLE1BQU0sT0FBTyxHQUFHLElBQUksY0FBSSxFQUFFLENBQUE7UUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQztZQUNULE1BQU0sRUFBRSxVQUFVO1lBQ2xCLEtBQUssRUFBRSx3QkFBd0I7WUFDL0IsUUFBUSxFQUFFLGFBQWE7WUFDdkIsU0FBUyxFQUFFLE9BQU87WUFDbEIsUUFBUSxFQUFFLEtBQUs7WUFDZixLQUFLLEVBQUUsYUFBYTtTQUN2QixDQUFDLENBQUE7UUFFRixNQUFNLElBQUksR0FBRyxJQUFJLGNBQUksRUFBRSxDQUFBO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDTixNQUFNLEVBQUUsU0FBUztZQUNqQixLQUFLLEVBQUUsc0JBQXNCO1lBQzdCLFFBQVEsRUFBRSxhQUFhO1lBQ3ZCLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFFBQVEsRUFBRSxLQUFLO1lBQ2YsS0FBSyxFQUFFLGFBQWE7U0FDdkIsQ0FBQyxDQUFBO1FBRUYsTUFBTSx3Q0FBbUIsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxZQUFZLENBQUMsRUFBRSxFQUFDLENBQUMsQ0FBQTtRQUUxRixPQUFPLENBQUMsSUFBSSxDQUFDLHdCQUFXLEVBQUUsd0JBQXdCLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDM0QsWUFBWTtTQUNiLENBQUMsQ0FBQTtRQUVGLE9BQU8sQ0FBQyxJQUFJLENBQUMsd0NBQW1CLEVBQUUsdUJBQXVCLENBQUMsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDakYsT0FBTyxDQUFDLElBQUksQ0FBQyx3QkFBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN6RCxPQUFPLENBQUMsSUFBSSxDQUFDLHdDQUFtQixFQUFFLHVCQUF1QixDQUFDLENBQUMsUUFBUSxFQUFFLENBQUE7UUFFckUsTUFBTSxPQUFPLEdBQUc7WUFDZCxRQUFRLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUNuQyxLQUFLLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztZQUNoRCxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQztTQUNwRCxDQUFBO1FBRUQsTUFBTSxRQUFRLEdBQUc7WUFDZixNQUFNLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtZQUNwQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRTtTQUNyQixDQUFBO1FBRUQsTUFBTSxJQUFJLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUE7UUFFM0IsTUFBTSxHQUFHLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBb0MsQ0FBQTtRQUV6RSxNQUFNLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxnQ0FBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ2hFLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDckMsTUFBTSxFQUFFLFNBQVM7WUFDakIsT0FBTyxFQUFFLHlDQUF5QztTQUNuRCxDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBQSxhQUFJLEVBQUMsdUNBQXVDLEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUNqRSxNQUFNLFVBQVUsR0FBRyxJQUFJLHlDQUErQixFQUFFLENBQUE7UUFFeEQsTUFBTSxPQUFPLEdBQUc7WUFDZCxRQUFRLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQ2pGLENBQUE7UUFFRCxNQUFNLFFBQVEsR0FBRztZQUNmLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ3BDLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFO1NBQ3JCLENBQUE7UUFFRCxNQUFNLEdBQUcsR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBb0MsQ0FBQTtRQUU3RSxNQUFNLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxnQ0FBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUE7UUFDbEYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNyQyxNQUFNLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQztTQUM5QixDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBQSxhQUFJLEVBQUMseURBQXlELEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUNuRixNQUFNLFVBQVUsR0FBRyxJQUFJLHlDQUErQixFQUFFLENBQUE7UUFFeEQsT0FBTyxDQUFDLElBQUksQ0FBQyx3QkFBVyxFQUFFLHdCQUF3QixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBRWhFLE1BQU0sT0FBTyxHQUFHO1lBQ2QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUU7WUFDbkMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7WUFDaEQsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLENBQUM7U0FDcEQsQ0FBQTtRQUVELE1BQU0sUUFBUSxHQUFHO1lBQ2YsTUFBTSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDcEMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7U0FDckIsQ0FBQTtRQUVELE1BQU0sSUFBSSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLG1CQUFtQixFQUFFLEVBQUUsQ0FBQTtRQUV0RCxNQUFNLEdBQUcsR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFvQyxDQUFBO1FBRXpFLE1BQU0sVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUU1QixNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGdDQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDekUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNyQyxNQUFNLEVBQUUsYUFBYTtZQUNyQixPQUFPLEVBQUUsaUNBQWlDO1lBQzFDLFVBQVUsRUFBRSxnQ0FBa0IsQ0FBQyxXQUFXO1NBQzNDLENBQUMsQ0FBQyxDQUFBO0lBQ0wsQ0FBQyxDQUFDLENBQUE7SUFzQ0YsSUFBQSxhQUFJLEVBQUMsc0NBQXNDLEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUNoRSxNQUFNLFVBQVUsR0FBRyxJQUFJLHlDQUErQixFQUFFLENBQUE7UUFFeEQsT0FBTyxDQUFDLElBQUksQ0FBQyx3QkFBVyxFQUFFLHdCQUF3QixDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQTtRQUV4RixNQUFNLE9BQU8sR0FBRztZQUNkLFFBQVEsRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFO1lBQ25DLEtBQUssRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDO1lBQ2hELElBQUksRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDO1NBQ3BELENBQUE7UUFFRCxNQUFNLFFBQVEsR0FBRztZQUNmLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ3BDLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSSxFQUFFO1NBQ3JCLENBQUE7UUFFRCxNQUFNLElBQUksR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxFQUFFLENBQUE7UUFFdEQsTUFBTSxHQUFHLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBb0MsQ0FBQTtRQUV6RSxNQUFNLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxnQ0FBa0IsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUE7UUFDbkYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNyQyxNQUFNLEVBQUUsT0FBTztZQUNmLE9BQU8sRUFBRSwyQkFBMkI7WUFDcEMsVUFBVSxFQUFFLGdDQUFrQixDQUFDLHFCQUFxQjtTQUNyRCxDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0ZXN0IH0gZnJvbSAnQGphcGEvcnVubmVyJ1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJ1xuaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgQWRkVXNlclRvT3JnYW5pc2F0aW9uQ29udHJvbGxlciBmcm9tICdBcHAvQ29udHJvbGxlcnMvSHR0cC9BZGRVc2VyVG9PcmdhbmlzYXRpb25Db250cm9sbGVyJ1xuaW1wb3J0IHsgT3JnYW5pc2F0aW9uQWN0aW9ucyB9IGZyb20gJ0FwcC9BY3Rpb25zL09yZ2FuaXNhdGlvbkFjdGlvbidcbmltcG9ydCB7IFVzZXJBY3Rpb25zIH0gZnJvbSAnQXBwL0FjdGlvbnMvVXNlckFjdGlvbidcbmltcG9ydCB7IEh0dHBTdGF0dXNDb2RlRW51bSB9IGZyb20gJ0FwcC9IZWxwZXJzL1N0YXR1c0NvZGVzJ1xuaW1wb3J0IE9yZ2FuaXNhdGlvbiBmcm9tICdBcHAvTW9kZWxzL09yZ2FuaXNhdGlvbidcbmltcG9ydCBVc2VyIGZyb20gJ0FwcC9Nb2RlbHMvVXNlcidcblxudGVzdC5ncm91cCgnQWRkVXNlclRvT3JnYW5pc2F0aW9uQ29udHJvbGxlcicsIChncm91cCkgPT4ge1xuICBsZXQgc2FuZGJveDogc2lub24uU2lub25TYW5kYm94XG5cbiAgZ3JvdXAuc2V0dXAoKCkgPT4ge1xuICAgIHNhbmRib3ggPSBzaW5vbi5jcmVhdGVTYW5kYm94KClcbiAgfSlcblxuICBncm91cC50ZWFyZG93bigoKSA9PiB7XG4gICAgc2FuZGJveC5yZXN0b3JlKClcbiAgfSlcblxuICB0ZXN0KCdzaG91bGQgYWRkIHVzZXIgdG8gb3JnYW5pc2F0aW9uIHN1Y2Nlc3NmdWxseScsIGFzeW5jICh7IGFzc2VydCB9KSA9PiB7XG4gICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBZGRVc2VyVG9PcmdhbmlzYXRpb25Db250cm9sbGVyKClcbiAgICBjb25zdCBvcmdhbmlzYXRpb24gPSBuZXcgT3JnYW5pc2F0aW9uKClcbiAgICBvcmdhbmlzYXRpb24uZmlsbCh7IG9yZ0lkOiAnb3JnYW5pc2F0aW9uLWlkJyxkZXNjcmlwdGlvbjogXCJuaWNlIG9yZ2FuaXNhdGlvblwiLCBuYW1lOiBcIm5ldyBvcmdhbmlzYXRpb25cIiB9KVxuICAgIFxuXG4gICAgY29uc3QgbmV3VXNlciA9IG5ldyBVc2VyKClcbiAgICBuZXdVc2VyLmZpbGwoe1xuICAgICAgICB1c2VySWQ6ICd1c2Vycy1pZCcsXG4gICAgICAgIGVtYWlsOiAnam9obnMuZG9lQGV4YW1wbGVzLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnLFxuICAgICAgICBmaXJzdE5hbWU6IFwiam9obnNcIixcbiAgICAgICAgbGFzdE5hbWU6IFwiZG9lXCIsXG4gICAgICAgIHBob25lOiBcIjA5MTIzNDU2Nzg5XCJcbiAgICB9KVxuXG4gICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKClcbiAgICB1c2VyLmZpbGwoe1xuICAgICAgICB1c2VySWQ6ICd1c2VyLWlkJyxcbiAgICAgICAgZW1haWw6ICdqb2huLmRvZUBleGFtcGxlLmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnLFxuICAgICAgICBmaXJzdE5hbWU6IFwiam9oblwiLFxuICAgICAgICBsYXN0TmFtZTogXCJkb2VcIixcbiAgICAgICAgcGhvbmU6IFwiMDkxMjM0NTY3ODlcIlxuICAgIH0pXG5cbiAgICBhd2FpdCBPcmdhbmlzYXRpb25BY3Rpb25zLmFkZFVzZXJUb09yZ2FuaXNhdGlvbih7dXNlcklkOiB1c2VyLmlkLCBvcmdJZDogb3JnYW5pc2F0aW9uLmlkfSlcblxuICAgIHNhbmRib3guc3R1YihVc2VyQWN0aW9ucywgJ2ZldGNoVXNlck9yZ2FuaXNhdGlvbnMnKS5yZXNvbHZlcyhbXG4gICAgICBvcmdhbmlzYXRpb25cbiAgICBdKVxuXG4gICAgc2FuZGJveC5zdHViKE9yZ2FuaXNhdGlvbkFjdGlvbnMsICdnZXRPcmdhbmlzYXRpb25SZWNvcmQnKS5yZXNvbHZlcyhvcmdhbmlzYXRpb24pXG4gICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZ2V0VXNlclJlY29yZCcpLnJlc29sdmVzKHVzZXIpXG4gICAgc2FuZGJveC5zdHViKE9yZ2FuaXNhdGlvbkFjdGlvbnMsICdhZGRVc2VyVG9PcmdhbmlzYXRpb24nKS5yZXNvbHZlcygpXG5cbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgdmFsaWRhdGU6IHNhbmRib3guc3R1YigpLnJlc29sdmVzKCksXG4gICAgICBwYXJhbTogc2FuZGJveC5zdHViKCkucmV0dXJucygnb3JnYW5pc2F0aW9uLWlkJyksXG4gICAgICBib2R5OiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zKHsgdXNlcklkOiAndXNlci1pZCcgfSlcbiAgICB9XG5cbiAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgIHN0YXR1czogc2FuZGJveC5zdHViKCkucmV0dXJuc1RoaXMoKSxcbiAgICAgIHNlbmQ6IHNhbmRib3guc3R1YigpXG4gICAgfVxuXG4gICAgY29uc3QgYXV0aCA9IHsgdXNlcjogdXNlciB9XG5cbiAgICBjb25zdCBjdHggPSB7IHJlcXVlc3QsIHJlc3BvbnNlLCBhdXRoIH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnN0YXR1cy5jYWxsZWRXaXRoKEh0dHBTdGF0dXNDb2RlRW51bS5PSykpXG4gICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAgICAgc3RhdHVzOiAnc3VjY2VzcycsXG4gICAgICBtZXNzYWdlOiAnVXNlciBhZGRlZCB0byBvcmdhbmlzYXRpb24gc3VjY2Vzc2Z1bGx5JyxcbiAgICB9KSlcbiAgfSlcblxuICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQyMiBpZiB2YWxpZGF0aW9uIGZhaWxzJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFkZFVzZXJUb09yZ2FuaXNhdGlvbkNvbnRyb2xsZXIoKVxuXG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIHZhbGlkYXRlOiBzYW5kYm94LnN0dWIoKS50aHJvd3MoeyBtZXNzYWdlczogeyBlcnJvcnM6IFsnVmFsaWRhdGlvbiBmYWlsZWQnXSB9IH0pXG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICBzdGF0dXM6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICBzZW5kOiBzYW5kYm94LnN0dWIoKVxuICAgIH1cblxuICAgIGNvbnN0IGN0eCA9IHsgcmVxdWVzdCwgcmVzcG9uc2UsIGF1dGg6IHt9IH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnN0YXR1cy5jYWxsZWRXaXRoKEh0dHBTdGF0dXNDb2RlRW51bS5VTlBST0NFU1NBQkxFX0VOVElUWSkpXG4gICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAgICAgZXJyb3JzOiBbJ1ZhbGlkYXRpb24gZmFpbGVkJ11cbiAgICB9KSlcbiAgfSlcblxuICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQwMCBpZiBvcmdhbmlzYXRpb24gaXMgbm90IGZvdW5kIGZvciB1c2VyJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFkZFVzZXJUb09yZ2FuaXNhdGlvbkNvbnRyb2xsZXIoKVxuXG4gICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZmV0Y2hVc2VyT3JnYW5pc2F0aW9ucycpLnJlc29sdmVzKFtdKVxuXG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIHZhbGlkYXRlOiBzYW5kYm94LnN0dWIoKS5yZXNvbHZlcygpLFxuICAgICAgcGFyYW06IHNhbmRib3guc3R1YigpLnJldHVybnMoJ29yZ2FuaXNhdGlvbi1pZCcpLFxuICAgICAgYm9keTogc2FuZGJveC5zdHViKCkucmV0dXJucyh7IHVzZXJJZDogJ3VzZXItaWQnIH0pXG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICBzdGF0dXM6IHNhbmRib3guc3R1YigpLnJldHVybnNUaGlzKCksXG4gICAgICBzZW5kOiBzYW5kYm94LnN0dWIoKVxuICAgIH1cblxuICAgIGNvbnN0IGF1dGggPSB7IHVzZXI6IHsgdXNlcklkOiAnbG9nZ2VkLWluLXVzZXItaWQnIH0gfVxuXG4gICAgY29uc3QgY3R4ID0geyByZXF1ZXN0LCByZXNwb25zZSwgYXV0aCB9IGFzIHVua25vd24gYXMgSHR0cENvbnRleHRDb250cmFjdFxuXG4gICAgYXdhaXQgY29udHJvbGxlci5oYW5kbGUoY3R4KVxuXG4gICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zdGF0dXMuY2FsbGVkV2l0aChIdHRwU3RhdHVzQ29kZUVudW0uQkFEX1JFUVVFU1QpKVxuICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc2VuZC5jYWxsZWRXaXRoKHtcbiAgICAgIHN0YXR1czogJ0JhZCBSZXF1ZXN0JyxcbiAgICAgIG1lc3NhZ2U6ICdPcmdhbmlzYXRpb24gbm90IGZvdW5kIGZvciB1c2VyJyxcbiAgICAgIHN0YXR1c0NvZGU6IEh0dHBTdGF0dXNDb2RlRW51bS5CQURfUkVRVUVTVFxuICAgIH0pKVxuICB9KVxuXG4gIC8vIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDAwIGlmIHVzZXIgaXMgbm90IGZvdW5kJywgYXN5bmMgKHsgYXNzZXJ0IH0pID0+IHtcbiAgLy8gICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFkZFVzZXJUb09yZ2FuaXNhdGlvbkNvbnRyb2xsZXIoKVxuXG4gIC8vICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZmV0Y2hVc2VyT3JnYW5pc2F0aW9ucycpLnJlc29sdmVzKFtcbiAgLy8gICAgIHsgb3JnSWQ6ICdvcmdhbmlzYXRpb24taWQnIH1cbiAgLy8gICBdKVxuICAvLyAgIHNhbmRib3guc3R1YihPcmdhbmlzYXRpb25BY3Rpb25zLCAnZ2V0T3JnYW5pc2F0aW9uUmVjb3JkJykucmVzb2x2ZXMoe1xuICAvLyAgICAgaWQ6ICdvcmdhbmlzYXRpb24taWQnLFxuICAvLyAgICAgbmFtZTogJ1Rlc3QgT3JnYW5pc2F0aW9uJ1xuICAvLyAgIH0pXG4gIC8vICAgc2FuZGJveC5zdHViKFVzZXJBY3Rpb25zLCAnZ2V0VXNlclJlY29yZCcpLnJlc29sdmVzKG51bGwpXG5cbiAgLy8gICBjb25zdCByZXF1ZXN0ID0ge1xuICAvLyAgICAgdmFsaWRhdGU6IHNhbmRib3guc3R1YigpLnJlc29sdmVzKCksXG4gIC8vICAgICBwYXJhbTogc2FuZGJveC5zdHViKCkucmV0dXJucygnb3JnYW5pc2F0aW9uLWlkJyksXG4gIC8vICAgICBib2R5OiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zKHsgdXNlcklkOiAndXNlci1pZCcgfSlcbiAgLy8gICB9XG5cbiAgLy8gICBjb25zdCByZXNwb25zZSA9IHtcbiAgLy8gICAgIHN0YXR1czogc2FuZGJveC5zdHViKCkucmV0dXJuc1RoaXMoKSxcbiAgLy8gICAgIHNlbmQ6IHNhbmRib3guc3R1YigpXG4gIC8vICAgfVxuXG4gIC8vICAgY29uc3QgYXV0aCA9IHsgdXNlcjogeyB1c2VySWQ6ICdsb2dnZWQtaW4tdXNlci1pZCcgfSB9XG5cbiAgLy8gICBjb25zdCBjdHggPSB7IHJlcXVlc3QsIHJlc3BvbnNlLCBhdXRoIH0gYXMgdW5rbm93biBhcyBIdHRwQ29udGV4dENvbnRyYWN0XG5cbiAgLy8gICBhd2FpdCBjb250cm9sbGVyLmhhbmRsZShjdHgpXG5cbiAgLy8gICBhc3NlcnQuaXNUcnVlKHJlc3BvbnNlLnN0YXR1cy5jYWxsZWRXaXRoKEh0dHBTdGF0dXNDb2RlRW51bS5CQURfUkVRVUVTVCkpXG4gIC8vICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAvLyAgICAgc3RhdHVzOiAnQmFkIFJlcXVlc3QnLFxuICAvLyAgICAgbWVzc2FnZTogJ0ludmFsaWQgdXNlcklkIHByb3ZpZGVkJ1xuICAvLyAgIH0pKVxuICAvLyB9KVxuXG4gIHRlc3QoJ3Nob3VsZCByZXR1cm4gNTAwIGlmIGFuIGVycm9yIG9jY3VycycsIGFzeW5jICh7IGFzc2VydCB9KSA9PiB7XG4gICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBZGRVc2VyVG9PcmdhbmlzYXRpb25Db250cm9sbGVyKClcblxuICAgIHNhbmRib3guc3R1YihVc2VyQWN0aW9ucywgJ2ZldGNoVXNlck9yZ2FuaXNhdGlvbnMnKS50aHJvd3MobmV3IEVycm9yKCdTaW11bGF0ZWQgZXJyb3InKSlcblxuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICB2YWxpZGF0ZTogc2FuZGJveC5zdHViKCkucmVzb2x2ZXMoKSxcbiAgICAgIHBhcmFtOiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zKCdvcmdhbmlzYXRpb24taWQnKSxcbiAgICAgIGJvZHk6IHNhbmRib3guc3R1YigpLnJldHVybnMoeyB1c2VySWQ6ICd1c2VyLWlkJyB9KVxuICAgIH1cblxuICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgc3RhdHVzOiBzYW5kYm94LnN0dWIoKS5yZXR1cm5zVGhpcygpLFxuICAgICAgc2VuZDogc2FuZGJveC5zdHViKClcbiAgICB9XG5cbiAgICBjb25zdCBhdXRoID0geyB1c2VyOiB7IHVzZXJJZDogJ2xvZ2dlZC1pbi11c2VyLWlkJyB9IH1cblxuICAgIGNvbnN0IGN0eCA9IHsgcmVxdWVzdCwgcmVzcG9uc2UsIGF1dGggfSBhcyB1bmtub3duIGFzIEh0dHBDb250ZXh0Q29udHJhY3RcblxuICAgIGF3YWl0IGNvbnRyb2xsZXIuaGFuZGxlKGN0eClcblxuICAgIGFzc2VydC5pc1RydWUocmVzcG9uc2Uuc3RhdHVzLmNhbGxlZFdpdGgoSHR0cFN0YXR1c0NvZGVFbnVtLklOVEVSTkFMX1NFUlZFUl9FUlJPUikpXG4gICAgYXNzZXJ0LmlzVHJ1ZShyZXNwb25zZS5zZW5kLmNhbGxlZFdpdGgoe1xuICAgICAgc3RhdHVzOiAnRXJyb3InLFxuICAgICAgbWVzc2FnZTogJ0Vycm9yIE9jY3VyZWQgQWRkaW5nIFVzZXInLFxuICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1c0NvZGVFbnVtLklOVEVSTkFMX1NFUlZFUl9FUlJPUlxuICAgIH0pKVxuICB9KVxufSlcbiJdfQ==